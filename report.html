<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Report</title>
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#2b6cb0" />
    <link rel="icon" type="image/png" sizes="32x32" href="/f/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/f/favicon-16x16.png" />
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css">

    <style>
      :root {
        --main-blue: #2b6cb0;
        --light-blue: #d0eaff;
        --bg: #f0f8ff;
        --white: #ffffff;
        --font: "Segoe UI", sans-serif;
      }
      body {
        font-family: var(--font);
        background: var(--bg);
        margin: 0;
        padding: 10px;
        box-sizing: border-box;
      }
      .meshst {
    display: none;
     }

      h2,
      h3 {
        color: var(--main-blue);
        margin-top: 20px;
      }
      button {
        padding: 12px;
        font-size: 1rem;
        background: #2b6cb0;
        color: white;
        border: none;
        border-radius: 8px;
        margin-top: 5px;
        margin-bottom: 15px;
        width: 48%;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: 0.2s ease-in-out;
      }
      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        margin-bottom: 12px;
      }
      .controls label {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: bold;
        color: var(--main-blue);
      }
      /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö radio buttons */
      .radio-group {
        display: flex;
        gap: 10px;
        align-items: center;
        font-weight: bold;
        color: var(--main-blue);
        flex-wrap: wrap;
      }
      .radio-group input[type="radio"] {
        margin-right: 5px;
        transform: scale(1.2);
      }
      .radio-group label {
        display: flex;
        align-items: center;
        gap: 4px;
        font-weight: normal;
        cursor: pointer;
      }

      /* ‡πÑ‡∏°‡πà‡∏°‡∏µ form-mini ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö date pickers ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡πÅ‡∏•‡πâ‡∏ß, Flatpickr ‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á input ‡∏Ç‡∏≠‡∏á‡∏°‡∏±‡∏ô‡πÄ‡∏≠‡∏á */
      .form-control-date { /* ‡∏Ñ‡∏•‡∏≤‡∏™‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö input ‡∏Ç‡∏≠‡∏á Flatpickr */
        width: 150px; /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ */
        padding: 8px;
        font-size: 1rem;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      .form-control-date1 { /* ‡∏Ñ‡∏•‡∏≤‡∏™‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö input ‡∏Ç‡∏≠‡∏á Flatpickr */
        width: 150px; /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ */
        padding: 8px;
        font-size: 1rem;
        border: 1px solid #ccc;
        border-radius: 4px;
      }

      .table-wrapper {
  overflow-x: auto;
  background: var(--white);
  border-radius: 10px;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
  margin-top: 5px;
  margin-bottom: 10px;
  font-size: 0.8rem;
  /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î */
  resize: both; /* ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á */
  min-width: 348px; /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£) */
}

      table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
        font-size: 0.7rem;
      }

      th,
      td {
        border: 1px solid #ccc;
        padding: 4px 2px;
        text-align: center;
        white-space: nowrap;
        vertical-align: middle;
      }
      th {
        background: var(--light-blue);
      }
      .average-row {
        background: #d0eaff!important;
        font-weight: bold;
      }

      /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏•‡∏≤‡∏™‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏µ‡πÉ‡∏´‡∏°‡πà */
      .highlight-pink {
        background-color: #ffccff !important; /* ‡∏Ç‡∏±‡∏îB,C */
      }
      .highlight-cyan {
        background-color: #99ccff !important; /* ‡∏¢‡∏Å‡∏•‡πâ‡∏≤‡∏áB,C */
      }
      .highlight-aquamarine {
        background-color: #98FB98 !important; /* ‡∏•‡πâ‡∏≤‡∏áFM&Ro */
      }
      .highlight-teal {
        background-color: #00FFFF !important; /* ‡∏¢‡∏Å‡∏•‡πâ‡∏≤‡∏áA,B,C */
      }
      .highlight-lightblue { /* ‡∏Ñ‡∏•‡∏≤‡∏™‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö #DDA0DD */
        background-color: #DDA0DD !important; /* ‡∏Ç‡∏±‡∏îB,C,‡∏•‡πâ‡∏≤‡∏áFM */
      }

      /* ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡πÅ‡∏Ñ‡∏ö‡∏•‡∏á */
      table th:nth-child(1),
      table td:nth-child(1) {
        width: 12%;
        min-width: 55px;
      }
      table th:nth-child(2),
      table td:nth-child(2) {
        width: 12%;
        min-width: 40px;
      }
      table th:nth-child(3),
      table td:nth-child(3) {
        width: 18%;
        min-width: 40px;
      }
      table th:nth-child(4),
      table td:nth-child(4) {
        width: 18%;
        min-width: 40px;
      }
      table th:nth-child(5),
      table td:nth-child(5) {
        width: 12%;
        min-width: 45px;
      }
      table th:nth-child(6),
      table td:nth-child(6) {
        width: 12%;
        min-width: 45px;
      }
      table th:nth-child(7),
      table td:nth-child(7) {
        width: 12%;
        min-width: 55px;
      }
      .date-input-group {
  display: flex; /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ label ‡πÅ‡∏•‡∏∞ input ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô */
  gap: 15px; /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á label ‡∏Å‡∏±‡∏ö input */
  align-items: flex-start; /* ‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏ä‡∏¥‡∏î‡∏ã‡πâ‡∏≤‡∏¢ */
  margin-right: 10px; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤‡∏ñ‡πâ‡∏≤‡∏°‡∏µ input ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ï‡∏≤‡∏°‡∏°‡∏≤ */
}

.date-input-group label {
  font-weight: bold; /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ label ‡∏´‡∏ô‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° */
  color: var(--main-blue); /* ‡∏™‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö label ‡∏≠‡∏∑‡πà‡∏ô‡πÜ */
  margin-bottom: 0; /* ‡∏•‡∏ö margin ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏Ç‡∏≠‡∏á label */
  white-space: nowrap; /* ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° label ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà */
}

/* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á input Date Picker ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏° */
.form-control-date {
  width: 150px; /* ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ */
  padding: 8px;
  font-size: 1rem;
  border: 1px solid #ccc;
  border-radius: 4px;
}

/* ‡∏õ‡∏£‡∏±‡∏ö controls flexbox ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà */
.controls {
  display: flex;
  flex-wrap: wrap; /* ‡πÉ‡∏´‡πâ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å */
  gap: 16px; /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏° control ‡∏ï‡πà‡∏≤‡∏á‡πÜ */
  margin-bottom: 12px;
}

      @media (max-width: 480px) {
        .controls {
          flex-direction: column;
        }
          .date-input-group {
    width: 100%; /* ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á */
    margin-right: 0; /* ‡∏•‡∏ö margin ‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤‡∏≠‡∏≠‡∏Å */
  }
  .form-control-date {
    width: 100%; /* input ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á */
  }
        table {
          font-size: 0.6rem;
          min-width: 320px;
        }
        th,
        td {
          padding: 3px 1px;
        }
        .form-control-date { /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
          width: 30%;
        }
                .form-control-date1 { /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
          width: 30%;
        }
      }
      th.machine-date {
        width: 60px;
      }
      th. {
        width: 60px;
      }
      th.reject-col {
        width: 60px;
      }
      th.cycleshift-col {
        width: 60px;
      }
      th.cycletime-col {
        width: 60px;
      }
      th.runtime-col {
        width: 60px;
      }
      th.trim-col {
        width: 60px;
      }
      th.shift-col {
        width: 60px;
      }
      th {
        text-align: center;
        padding: 4px;
      }
      td {
        text-align: center;
        padding: 2px;
      }
      input.table-input {
        width: 50px;
        text-align: right;
      }

      .color-legend {
        margin-top: 3px;
        margin-inline: 5px;
        padding: 0;
        background: none;
        box-shadow: none;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: flex-start;
        align-items: center;
        font-size: 0.9rem;
        color: var(--main-blue);
        font-weight: bold;
        display: none;
      }

      .legend-item {
        font-size: 10px;
        display: flex;
        align-items: center;
        gap: 5px;
        margin: 0;
        padding: 0;
      }

      .legend-color {
        width: 10px;
        height: 10px;
        border-radius: 4px;
        display: inline-block;
        border: 1px solid rgba(0, 0, 0, 0.1);
      }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/th.js"></script>

  </head>
  <body>
    <button onclick="window.location.href='/index.html?i=1'">üè† ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
    <button onclick="window.location.href='/summary.html?i=1'">üìÑ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    <button onclick="window.location.href='/running.html?i=1'">‚è≥ Running Time</button>
   <button onclick="window.location.href='/stamesh.html?i=1'">ü™£ Mesh Creaning</button>
        <h2 style="margin-top: 30px; font-size: 20px;">‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Cycle Time</h2>
    <div class="controls">
      <label>
        üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:
        <input type="text" id="recentDatePicker" class="form-control-date" />
      </label>
      <div id="dateDisplayText" style="display: none;"></div>
      <div class="radio-group">
        üïë ‡∏Å‡∏∞:
        <label> <input type="radio" name="shiftOption" value="all" id="shiftAll" checked /> ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î </label>
        <label> <input type="radio" name="shiftOption" value="‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤" id="shiftMorning" /> ‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤ </label>
        <label> <input type="radio" name="shiftOption" value="‡∏Å‡∏∞‡∏ö‡πà‡∏≤‡∏¢" id="shiftAfternoon" /> ‡∏Å‡∏∞‡∏ö‡πà‡∏≤‡∏¢ </label>
        <label> <input type="radio" name="shiftOption" value="‡∏Å‡∏∞‡∏î‡∏∂‡∏Å" id="shiftNight" /> ‡∏Å‡∏∞‡∏î‡∏∂‡∏Å </label>
      </div>
    </div>
    <div class="table-wrapper">
      <table id="recentTable">
        <thead>
          <tr>
            <th class="machine-col">Machine</th>
            <th class="reject-col">Reject</th>
            <th class="cycleshift-col">Cycle Shift</th>
            <th class="cycletime-col">Cycle Time</th>
            <th class="runtime-col">Run Time</th>
            <th class="trim-col">Trim</th>
            <th class="shift-col">Shift</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="color-legend">
        <div class="legend-item">
          <span class="legend-color highlight-teal"></span>
          <span class="legend-text">‡∏¢‡∏Å‡∏•‡πâ‡∏≤‡∏áA,B,C</span>
        </div>
        <div class="legend-item">
          <span class="legend-color highlight-lightblue"></span>
          <span class="legend-text">‡∏Ç‡∏±‡∏îB,C,‡∏•‡πâ‡∏≤‡∏áFM</span>
        </div>
        <div class="legend-item">
          <span class="legend-color highlight-aquamarine"></span>
          <span class="legend-text">‡∏•‡πâ‡∏≤‡∏áFM&Ro</span>
        </div>
        <div class="legend-item">
          <span class="legend-color highlight-cyan"></span>
          <span class="legend-text">‡∏¢‡∏Å‡∏•‡πâ‡∏≤‡∏á B,C</span>
        </div>
        <div class="legend-item">
          <span class="legend-color highlight-pink"></span>
          <span class="legend-text">‡∏Ç‡∏±‡∏îMold B,C</span>
        </div>
      </div>
      <div style="margin-top: 10px; text-align: right;">
      <button id="shareRecentImageBtn" class="btn btn-info btn-sm">
        <i class="fas fa-share-alt"></i> üì§ ‡πÅ‡∏ä‡∏£‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
      </button>
      <button id="exportRecentImageBtn" class="btn btn-primary btn-sm">
        <i class="fas fa-download"></i> üì∑ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
      </button>
</div>
    </div>
<div class="meshst">
  <h2 style="margin-top: 30px; font-size: 20px;">‡∏ú‡∏•‡∏£‡∏ß‡∏° Run Time ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Mesh Status</h2>
<div class="controls">
    <label>
        ‚öôÔ∏è ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á:
        <select id="machineLetterSelect" class="form-mini">
            <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
            <option value="A">A</option>
            <option value="B">B</option>
            <option value="C">C</option>
        </select>
        <select id="machineNumberSelect" class="form-mini">
            <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
        </select>
    </label>
    <div class="date-input-group">
        <label for="summaryStartDatePicker">üóìÔ∏è ‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô:</label>
        <label for="summaryEndDatePicker">üóìÔ∏è ‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
    </div>
    <div class="date-input-group">
     <input type="text" id="summaryStartDatePicker" class="form-control-date" />
     <input type="text" id="summaryEndDatePicker" class="form-control-date" />
    </div>
</div>
<div class="table-wrapper">
  <table id="summaryTable">
    <thead>
      <tr>
        <th class="machine-date">Date</th>
        <th>Machine</th>
        <th>RunTime</th>
        <th>Shift</th>
        <th>Status</th>
        <th>Sum Time</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <div style="text-align: center; margin-top: 10px;">
    <button onclick="shareSummaryImage()">üì§ ‡πÅ‡∏ä‡∏£‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ú‡∏•‡∏£‡∏ß‡∏°</button>
    <button onclick="exportSummaryImage()">üì∑ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ú‡∏•‡∏£‡∏ß‡∏°</button>
  </div>
</div>
</div>


      <script>
      let allData = [],
        lastCanvas = null,
        lastMachineCount = 0;
      let dataTable; // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö recentTable
      let summaryDataTable; // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö summaryTable

      // Global Flatpickr instances for easy access
      let recentDatePickerInstance;
      let summaryStartDatePickerInstance;
      let summaryEndDatePickerInstance;

      $.extend($.fn.dataTable.ext.type.order, {
        "machine-sort-asc": function (a, b) {
          const re = /^([A-Za-z]+)(\d+)$/;
          const matchA = a.match(re);
          const matchB = b.match(re);

          if (!matchA || !matchB) {
            return a.localeCompare(b);
          }

          const [_, charA, numA] = matchA;
          const [__, charB, numB] = matchB;

          if (charA === charB) {
            return parseInt(numA) - parseInt(numB);
          }
          return charA.localeCompare(charB);
        },
        "machine-sort-desc": function (a, b) {
          const re = /^([A-Za-z]+)(\d+)$/;
          const matchA = a.match(re);
          const matchB = b.match(re);

          if (!matchA || !matchB) {
            return b.localeCompare(a);
          }

          const [_, charA, numA] = matchA;
          const [__, charB, numB] = matchB;

          if (charA === charB) {
            return parseInt(numB) - parseInt(numA);
          }
          return charB.localeCompare(charA);
        },
      });

      async function loadData() {
        try {
          // *** ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢ API Key ‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ***
          const apiKey = "AIzaSyB_Jrjw4_H6qm4QTUUSCcz5z2A7xGL_dAQ"; // <--- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ!
          const spreadsheetId = "1Nmcrwydbke_qMdMqYEH2Mk85MQzy3bsRQVSfLKP5Edw"; // Replace with your actual Spreadsheet ID
          const range = "Cycle_Time!A2:L"; // Adjust range if your data changes

          const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${range}?key=${apiKey}`;
          
          const res = await fetch(url);
          if (!res.ok) {
            const errorText = await res.text();
            throw new Error(`HTTP error! status: ${res.status}, Message: ${errorText}`);
          }
          const json = await res.json();
          allData = json.values || [];
          console.log("All data loaded:", allData);
          // ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å updateRecentTableDisplay() ‡πÅ‡∏•‡∏∞ calculateAndDisplaySummary() 
          // ‡∏à‡∏∞‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡πÉ‡∏ô $(async () => {}) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤ Flatpickr ‡∏ñ‡∏π‡∏Å initialized ‡πÅ‡∏•‡πâ‡∏ß
        } catch (error) {
          console.error("Error loading data from Google Sheets:", error);
          alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö API Key, ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå Google Sheet, ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏à‡∏≤‡∏Å API Console");
          $("#recentTable tbody").html('<tr><td colspan="7">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö API Key ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google Sheet</td></tr>');
          $("#summaryTable tbody").html('<tr><td colspan="6">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö API Key ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google Sheet</td></tr>');
        }
      }

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á "‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Cycle Time" ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
      function updateRecentTableDisplay() {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ recentDatePickerInstance ‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        const selectedDateFormatted = recentDatePickerInstance ? recentDatePickerInstance.input.value : null; 

        if (!selectedDateFormatted) {
            console.warn("No date selected for recentTable. Using default or stopping.");
            $("#recentTable tbody").html('<tr><td colspan="7">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</td></tr>');
            // ‡∏ó‡∏≥‡∏•‡∏≤‡∏¢ DataTable ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô error
            if ($.fn.DataTable.isDataTable("#recentTable")) {
                dataTable.destroy();
                $("#recentTable tbody").empty();
            }
            return; // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        }

        $("#dateDisplayText").text(`üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ${selectedDateFormatted}`);
        console.log("Selected Date for recentTable filtering:", selectedDateFormatted);

        const shift = $('input[name="shiftOption"]:checked').val();

        let sum = [0, 0, 0, 0, 0],
          cnt = 0;

        const filteredRows = allData.filter((r) => {
          const rowDate = r[0]; // Column A: Date (assuming YYYY-MM-DD format from sheet)
          const rowShift = r[8]; // Column I: Shift

          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö rowDate ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö
          const dateMatch = (rowDate && rowDate === selectedDateFormatted);
          const shiftMatch = (shift === "all" || rowShift === shift);

          return dateMatch && shiftMatch;
        });

        console.log("Filtered Rows for recentTable:", filteredRows);

        const dataForTable = filteredRows.map((r) => {
          // Ensure r[3] to r[7] are valid numbers for summation, default to 0 if not
          sum[0] += parseFloat(r[3]) || 0; // Reject (Column D)
          sum[1] += parseFloat(r[4]) || 0; // Cycle Shift (Column E)
          sum[2] += parseFloat(r[5]) || 0; // Cycle Time (Column F)
          sum[3] += parseFloat(r[6]) || 0; // Run Time (Column G)
          sum[4] += parseFloat(r[7]) || 0; // Trim (Column H)
          cnt++;
          return [r[2], r[3], r[4], r[5], r[6], r[7], r[8], r[9], r[10], r[11]]; // Columns: C, D, E, F, G, H, I, J, K, L
        });

        lastMachineCount = cnt;

        if ($.fn.DataTable.isDataTable("#recentTable")) {
          dataTable.destroy();
          $("#recentTable tbody").empty();
        }

        dataTable = $("#recentTable").DataTable({
          data: dataForTable,
          columns: [
            { title: "Machine", data: 0 }, // C
            { title: "Reject", data: 1 },    // D
            { title: "Cycle Shift", data: 2 }, // E
            { title: "Cycle Time", data: 3 },  // F
            { title: "Run Time", data: 4 },    // G
            { title: "Trim", data: 5 },      // H
            { title: "Shift", data: 6 },     // I
          ],
          paging: false,
          searching: false,
          info: false,
          order: [[0, "asc"]],
          columnDefs: [
            {
              targets: 0,
              type: "machine-sort",
            },
          ],
          createdRow: function (row, data, dataIndex) {
            const colJ = data[7]; // Column J (Mesh Status)
            const colK = data[8]; // Column K (Mold Status)
            const colL = data[9]; // Column L (Change Mold Status)

            // *** ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ç‡∏≠‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏™‡∏µ (‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô) ***
            if (colJ === "Yes" && colK === "Yes" && colL === "Yes") {
              $(row).addClass("highlight-teal"); // ‡∏¢‡∏Å‡∏•‡πâ‡∏≤‡∏áA,B,C (#00FFFF)
            } else if (colJ === "Yes" && colL === "Yes") {
              $(row).addClass("highlight-lightblue"); // ‡∏Ç‡∏±‡∏îB,C,‡∏•‡πâ‡∏≤‡∏áFM (#DDA0DD)
            } else if (colL === "Yes") {
              $(row).addClass("highlight-aquamarine"); // ‡∏•‡πâ‡∏≤‡∏áFM&Ro (#98FB98)
            } else if (colJ === "Yes" && colK === "Yes") {
              $(row).addClass("highlight-cyan"); // ‡∏¢‡∏Å‡∏•‡πâ‡∏≤‡∏á B,C (#99CCFF)
            } else if (colJ === "Yes") {
              $(row).addClass("highlight-pink"); // ‡∏Ç‡∏±‡∏îMold B,C (#FFCCFF)
            }
          },
        });

        if (cnt > 0) {
          const avgSumDisplay = sum; // sum contains calculated sums for Reject, Cycle Shift, Cycle Time, Run Time, Trim
          const avgRowHtml = `<tr class="average-row"><td>AVG</td>${avgSumDisplay.map((v, index) => `<td>${(v / cnt).toFixed(2)}</td>`).join("")}<td>${lastMachineCount} ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</td></tr>`;
          $("#recentTable tbody").append(avgRowHtml);
        }

        const $colorLegend = $(".color-legend");
        const $legendTeal = $colorLegend.find(".legend-item:nth-child(1)");
        const $legendLightblue = $colorLegend.find(".legend-item:nth-child(2)");
        const $legendAquamarine = $colorLegend.find(".legend-item:nth-child(3)");
        const $legendCyan = $colorLegend.find(".legend-item:nth-child(4)");
        const $legendPink = $colorLegend.find(".legend-item:nth-child(5)");


        $colorLegend.hide();
        $legendTeal.hide();
        $legendLightblue.hide();
        $legendAquamarine.hide();
        $legendCyan.hide();
        $legendPink.hide();

        let hasTeal = false;
        let hasLightblue = false;
        let hasAquamarine = false;
        let hasCyan = false;
        let hasPink = false;


        dataTable.rows().every(function () {
          const rowNode = this.node();
          if ($(rowNode).hasClass("highlight-teal")) {
            hasTeal = true;
          }
          if ($(rowNode).hasClass("highlight-lightblue")) {
            hasLightblue = true;
          }
          if ($(rowNode).hasClass("highlight-aquamarine")) {
            hasAquamarine = true;
          }
          if ($(rowNode).hasClass("highlight-cyan")) {
            hasCyan = true;
          }
          if ($(rowNode).hasClass("highlight-pink")) {
            hasPink = true;
          }
          if (hasTeal && hasLightblue && hasAquamarine && hasCyan && hasPink) {
            return false;
          }
        });

        if (hasTeal || hasLightblue || hasAquamarine || hasCyan || hasPink) {
          $colorLegend.css("display", "flex");
          if (hasTeal) {
            $legendTeal.show();
          }
          if (hasLightblue) {
            $legendLightblue.show();
          }
          if (hasAquamarine) {
            $legendAquamarine.show();
          }
          if (hasCyan) {
            $legendCyan.show();
          }
          if (hasPink) {
            $legendPink.show();
          }
        }
      }

      // Function to set the initial shift based on current time
      function setInitialShift() {
          const now = new Date();
          const hour = now.getHours(); // ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (0-23)
          const minute = now.getMinutes(); // ‡∏ô‡∏≤‡∏ó‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (0-59)

          const currentTimeInMinutes = hour * 60 + minute;

          const morningShiftStart = 8 * 60;
          const morningShiftEnd = 16 * 60 - 1;

          const afternoonShiftStart = 16 * 60;
          const afternoonShiftEnd = 24 * 60 - 1;

          const nightShiftStart = 0 * 60;
          const nightShiftEnd = 8 * 60 - 1;

          if (currentTimeInMinutes >= morningShiftStart && currentTimeInMinutes <= morningShiftEnd) {
              $('#shiftMorning').prop('checked', true);
              console.log("‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô: ‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤");
          } else if (currentTimeInMinutes >= afternoonShiftStart && currentTimeInMinutes <= afternoonShiftEnd) {
              $('#shiftAfternoon').prop('checked', true);
              console.log("‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô: ‡∏Å‡∏∞‡∏ö‡πà‡∏≤‡∏¢");
          } else if (currentTimeInMinutes >= nightShiftStart && currentTimeInMinutes <= nightShiftEnd) {
              $('#shiftNight').prop('checked', true);
              console.log("‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô: ‡∏Å‡∏∞‡∏î‡∏∂‡∏Å");
          } else {
              $('#shiftAll').prop('checked', true);
              console.log("‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô: ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Å‡∏∞‡πÉ‡∏î‡πÜ)");
          }
          updateRecentTableDisplay(); 
      }

      async function generateImageForDownload() {
        const d = $("#dateDisplayText").text().replace("üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ", "") || "-";
        const s = $('input[name="shiftOption"]:checked').val();
        const map = {
          all: "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î",
          ‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤: "‡πÄ‡∏ä‡πâ‡∏≤",
          ‡∏Å‡∏∞‡∏ö‡πà‡∏≤‡∏¢: "‡∏ö‡πà‡∏≤‡∏¢",
          ‡∏Å‡∏∞‡∏î‡∏∂‡∏Å: "‡∏î‡∏∂‡∏Å",
        };

        let formattedDate = d;
        if (d !== "-") {
          const dateParts = d.split('-');
          if (dateParts.length === 3) {
            const year = dateParts[0];
            const month = dateParts[1];
            const day = dateParts[2];
            formattedDate = `${day}/${month}/${year}`;
          }
        }

        const cont = document.createElement("div");
        cont.style.padding = "14px";
        cont.style.background = "#fff";
        cont.style.fontFamily = "sans-serif";
        cont.style.width = "fit-content";
        cont.style.display = "inline-block";

        const h = document.createElement("h3");
        h.textContent = "Cycle Time Report";
        h.style.marginTop = "5px";
        h.style.marginBottom = "2px";
        h.style.fontSize = "20px";
        h.style.color = "#2b6cb0";

        const summaryAndLegendContainer = document.createElement("div");
        summaryAndLegendContainer.style.display = "flex";
        summaryAndLegendContainer.style.alignItems = "center";
        summaryAndLegendContainer.style.gap = "10px";

        const m = document.createElement("div");
        m.textContent = `Date: ${formattedDate} | Shift: ${map[s] || s} | ${lastMachineCount} Machine`;
        m.style.fontSize = "10px";
        m.style.whiteSpace = "nowrap";
        summaryAndLegendContainer.append(m);

        const $colorLegendHtml = $(".color-legend");
        if ($colorLegendHtml.css("display") !== "none") {
          const clonedLegend = $colorLegendHtml.clone();

          clonedLegend.css({
            margin: "0",
            padding: "0",
            background: "none",
            "box-shadow": "none",
            border: "none",
            "font-size": "7px",
            width: "auto",
            display: "flex",
            "justify-content": "flex-start",
            gap: "3px",
          });
          clonedLegend.find(".legend-color").css({
            width: "6px",
            height: "6px",
            border: "1px solid #ccc",
            gap: "1px",
          });
          clonedLegend.find(".legend-text").css({
            "white-space": "nowrap",
            "font-size": "7px",
          });

          clonedLegend.find(".legend-item").each(function () {
            if ($(this).css("display") === "none") {
              $(this).remove();
            }
          });

          summaryAndLegendContainer.append(clonedLegend[0]);
        }

        cont.append(h, summaryAndLegendContainer);

        const newTable = document.createElement("table");
        newTable.style.border = "1px solid #ccc";
        newTable.style.borderCollapse = "collapse";
        newTable.style.fontSize = "8px";

        const thead = document.createElement("thead");
        const headerRow = document.querySelector("#recentTable thead tr").cloneNode(true);
        thead.appendChild(headerRow);
        newTable.appendChild(thead);
        const tbody = document.createElement("tbody");
        dataTable.rows().every(function () {
          const rowData = this.data();
          const tr = document.createElement("tr");
          for (let i = 0; i < 7; i++) {
            const td = document.createElement("td");
            td.textContent = rowData[i];
            tr.appendChild(td);
          }

          const colJ = rowData[7];
          const colK = rowData[8];
          const colL = rowData[9];

          if (colJ === "Yes" && colK === "Yes" && colL === "Yes") {
              $(tr).addClass("highlight-teal");
            } else if (colJ === "Yes" && colL === "Yes") {
             $(tr).addClass("highlight-lightblue");
            } else if (colL === "Yes") {
              $(tr).addClass("highlight-aquamarine");
            } else if (colJ === "Yes" && colK === "Yes") {
              $(tr).addClass("highlight-cyan");
            } else if (colJ === "Yes") {
              $(tr).addClass("highlight-pink");
            }

          tbody.appendChild(tr);
        });

        const avgRowHtmlElement = document.querySelector("#recentTable tbody .average-row");
        if (avgRowHtmlElement) {
          tbody.appendChild(avgRowHtmlElement.cloneNode(true));
        }
        newTable.appendChild(tbody);
        const headerCells = document.querySelector("#recentTable thead tr").children;

        if (headerCells.length > 0) {
          headerCells[0].style.width = "15%";
          headerCells[1].style.width = "10%";
          headerCells[2].style.width = "15%x";
          headerCells[3].style.width = "15%";
          headerCells[4].style.width = "10%";
          headerCells[5].style.width = "10%";
          headerCells[6].style.width = "10%";
        } newTable.appendChild(thead); // <-- ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏î‡∏π‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô
        // ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å thead ‡∏ñ‡∏π‡∏Å append ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î newTable.appendChild(thead); ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏Å‡∏ß‡πà‡∏≤

        newTable.querySelectorAll("th, td").forEach((cell) => {
          cell.style.border = "1px solid #ccc";
          cell.style.padding = "4px 5px";
          cell.style.fontSize = "9px";
          cell.style.whiteSpace = "nowrap";
          cell.style.verticalAlign = "middle";
          cell.style.textAlign = "center";
        });

        if (avgRowHtmlElement) {
          newTable.querySelector(".average-row").style.backgroundColor = "#d8f0ff";
          newTable.querySelector(".average-row").style.fontWeight = "bold";
        }

        cont.append(newTable);
        document.body.appendChild(cont); // ‡∏ï‡πâ‡∏≠‡∏á append ‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á‡∏à‡∏∞ html2canvas ‡πÑ‡∏î‡πâ
        const canvas = await html2canvas(cont, {
          scale: 2,
        });
        document.body.removeChild(cont); // ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏î‡πâ canvas ‡πÅ‡∏•‡πâ‡∏ß
        return canvas;
      }

      async function exportRecentImage() {
        console.log("Attempting to export image...");
        const canvas = await generateImageForDownload();
        if (!canvas) {
          console.error("Canvas is null, cannot export image.");
          return;
        }

        const d = $("#dateDisplayText").text().replace("üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ", "") || "report";
        const a = document.createElement("a");
        a.download = `CycleTime_${d}.png`;
        a.href = canvas.toDataURL("image/png");
        a.click();
        console.log("Image export initiated.");
      }

      async function shareRecentImage() {
        console.log("Attempting to share image...");
        const canvas = await generateImageForDownload();
        if (!canvas) {
          console.error("Canvas is null, cannot share image.");
          return;
        }

        const d = $("#dateDisplayText").text().replace("üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ", "") || "report";
        const filename = `CycleTime_${d}.png`;

        try {
            const blob = await new Promise(resolve => canvas.toBlob(resolve, "image/png"));
            if (!blob) {
                throw new Error("Failed to create Blob from Canvas.");
            }
            const file = new File([blob], filename, {
                type: "image/png",
            });

            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                await navigator.share({
                    files: [file],
                    title: "Cycle Time Report",
                    text: `Cycle Time Report for ${$("#dateDisplayText").text().replace("üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ", "") || "-"}`,
                });
                console.log("Image shared successfully.");
            } else {
                alert("‚ùå ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î");
                console.warn("Web Share API not supported or cannot share files.");
            }
        } catch (error) {
            console.error("Error sharing image:", error);
        }
      }

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏£‡∏ß‡∏° Run Time ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Mesh Status ("Yes")
      function calculateAndDisplaySummary() {
        const summaryData = [];
        const machineLetter = $('#machineLetterSelect').val();
        const machineNumber = $('#machineNumberSelect').val();
        
        // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å Flatpickr, ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ instances ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
        const startDate = summaryStartDatePickerInstance ? summaryStartDatePickerInstance.input.value : null;
        const endDate = summaryEndDatePickerInstance ? summaryEndDatePickerInstance.input.value : null;

        // ‡∏´‡∏≤‡∏Å startDate ‡∏´‡∏£‡∏∑‡∏≠ endDate ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
        if (!startDate || !endDate) {
            console.warn("Start or End date is missing for summary table. Cannot calculate summary.");
            $("#summaryTable tbody").html('<tr><td colspan="6">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå</td></tr>');
            // ‡∏ó‡∏≥‡∏•‡∏≤‡∏¢ DataTable ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô error
            if ($.fn.DataTable.isDataTable("#summaryTable")) {
                summaryDataTable.destroy();
                $("#summaryTable tbody").empty();
            }
            return; // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ñ‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå
        }
        console.log(`Calculating Summary for: Start Date: ${startDate}, End Date: ${endDate}, Machine: ${machineLetter}${machineNumber}`);


        // 1. ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏° Machine ‡πÅ‡∏•‡∏∞ Date Range
        let filteredDataForSummary = allData.filter((r) => {
          const rowDate = r[0]; // Column A: Date (assuming YYYY-MM-DD format from sheet)
          const rowMachine = r[2]; // Column C: Mac

          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤ rowDate ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà undefined/null ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö
          if (!rowDate) return false;

          const dateMatch = (rowDate >= startDate && rowDate <= endDate);

          let machineMatch = true;
          if (machineLetter !== 'all' && machineNumber !== 'all') {
            machineMatch = (rowMachine === `${machineLetter}${machineNumber}`);
          } else if (machineLetter !== 'all') {
            machineMatch = (rowMachine && rowMachine.startsWith(machineLetter));
          } else if (machineNumber !== 'all') {
            machineMatch = (rowMachine && rowMachine.endsWith(machineNumber));
          }
          return dateMatch && machineMatch;
        });

        // Sort data for correct sequence-based summation
        filteredDataForSummary.sort((a, b) => {
            const dateA = a[0];
            const dateB = b[0];
            if (dateA !== dateB) return dateA.localeCompare(dateB);

            const machineA = a[2];
            const machineB = b[2];
            if (machineA !== machineB) return machineA.localeCompare(machineB);
            
            const shiftOrder = {"‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤": 1, "‡∏Å‡∏∞‡∏ö‡πà‡∏≤‡∏¢": 2, "‡∏Å‡∏∞‡∏î‡∏∂‡∏Å": 3, "all": 4, "": 5};
            const shiftA = a[8] || "";
            const shiftB = b[8] || "";
            if (shiftOrder[shiftA] !== shiftOrder[shiftB]) {
                return shiftOrder[shiftA] - shiftOrder[shiftB];
            }
            return 0;
        });


        // 2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Sum Run ‡∏ï‡∏≤‡∏°‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏°‡∏≤
        let currentSumRun = 0;
        let segmentData = [];
        const displayRows = [];

        for (let i = 0; i < filteredDataForSummary.length; i++) {
            const row = filteredDataForSummary[i];
            const runTime = parseFloat(row[6]) || 0; // Column G
            const meshStatus = row[9]; // Column J

            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡πÉ‡∏ô segmentData ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏°‡∏≠
            segmentData.push({
                date: row[0],
                machine: row[2],
                runTime: runTime,
                shift: row[8],
                meshStatus: meshStatus
            });
            currentSumRun += runTime;

            // ‡∏ñ‡πâ‡∏≤ Mesh Status ‡πÄ‡∏õ‡πá‡∏ô "Yes" ‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏£‡∏ß‡∏°‡πÅ‡∏•‡∏∞‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
            if (meshStatus === "Yes") {
                const lastRowInSegment = segmentData[segmentData.length - 1]; // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î "Yes"
                displayRows.push([
                    lastRowInSegment.date,
                    lastRowInSegment.machine,
                    lastRowInSegment.runTime.toFixed(2), // ‡πÅ‡∏™‡∏î‡∏á Run Time ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏ß‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î "Yes"
                    lastRowInSegment.shift,
                    lastRowInSegment.meshStatus,
                    currentSumRun.toFixed(2) // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏£‡∏ß‡∏° Run Time ‡∏Ç‡∏≠‡∏á segment
                ]);
                
                // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö segment ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                currentSumRun = 0;
                segmentData = [];
            }
        }
        console.log("Summary Display Rows:", displayRows);
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡∏•‡∏≤‡∏¢ DataTable ‡πÄ‡∏Å‡πà‡∏≤
        if ($.fn.DataTable.isDataTable("#summaryTable")) {
          summaryDataTable.destroy();
          $("#summaryTable tbody").empty();
        }

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á DataTable ‡πÉ‡∏´‡∏°‡πà
        summaryDataTable = $("#summaryTable").DataTable({
          data: displayRows,
          columns: [
            { title: "Date", data: 0 },
            { title: "Machine", data: 1 },
            { title: "RunTime", data: 2 },
            { title: "Shift", data: 3 },
            { title: "Status", data: 4 },
            { title: "Sum Time", data: 5 },
          ],
          paging: false,
          searching: false,
          info: false,
          order: [[0, "asc"], [1, "asc"], [3, "asc"]],
        });
      }


async function generateSummaryImage() {
    const cont = document.createElement("div");
    cont.style.padding = "20px";
    cont.style.background = "#fff";
    cont.style.fontFamily = "sans-serif";
    cont.style.width = "fit-content";
    cont.style.display = "inline-block";

    const h = document.createElement("h3");
    h.textContent = "‡∏ú‡∏•‡∏£‡∏ß‡∏° Run Time ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Mesh Status"; // ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô "‡∏ú‡∏•‡∏™‡∏£‡∏∏‡∏õ Run Time ‡πÅ‡∏•‡∏∞ Sum Time"
    h.style.marginTop = "5px";
    h.style.marginBottom = "5px";
    h.style.fontSize = "17px";
    h.style.color = "#2b6cb0";
    cont.append(h);

    // --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Machine No. ‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ---
    const machineLetter = $('#machineLetterSelect').val();
    const machineNumber = $('#machineNumberSelect').val();
    const startDate = summaryStartDatePickerInstance ? summaryStartDatePickerInstance.input.value : 'N/A';
    const endDate = summaryEndDatePickerInstance ? summaryEndDatePickerInstance.input.value : 'N/A';

    let machineInfo = '';
    if (machineLetter !== 'all' || machineNumber !== 'all') {
        machineInfo = `${machineLetter === 'all' ? '' : machineLetter}${machineNumber === 'all' ? '' : machineNumber}`;
    } else {
        machineInfo = 'All'; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å 'Machine No: All' ‡πÄ‡∏õ‡πá‡∏ô 'All'
    }

    // *** ‡∏¢‡πâ‡∏≤‡∏¢‡∏ö‡∏•‡πá‡∏≠‡∏Å h2 ‡∏°‡∏≤‡πÑ‡∏ß‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ machineInfo ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß ***
    const h2 = document.createElement("h2");
    h2.textContent = `Machine No : ${machineInfo}`; // << ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
    h2.style.marginTop = "2px";
    h2.style.marginBottom = "2px";
    h2.style.fontSize = "13px";
    h2.style.color = "#2b6cb0";
    cont.append(h2);
    // *** ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢‡∏ö‡∏•‡πá‡∏≠‡∏Å h2 ***

    // Convert dates to DD/MM/YYYY for display
    const formatThaiDate = (dateStr) => {
        if (!dateStr || dateStr === 'N/A') return 'N/A';
        const parts = dateStr.split('-'); // YYYY-MM-DD
        if (parts.length === 3) {
            return `${parts[2]}/${parts[1]}/${parts[0]}`;
        }
        return dateStr;
    };

    const startDateFormatted = formatThaiDate(startDate);
    const endDateFormatted = formatThaiDate(endDate);

    // --- ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡πÅ‡∏•‡∏∞ ‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏Ç‡∏≠‡∏á "Sum Time" ---
    let totalCount = 0;
    let sumOfSumTime = 0; // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå "Sum Time"
    let averageSumTime = 0; // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏Ç‡∏≠‡∏á "Sum Time"

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ summaryDataTable ‡∏ñ‡∏π‡∏Å initialize ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    if (summaryDataTable && summaryDataTable.rows().any()) {
        totalCount = summaryDataTable.rows().count(); // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ñ‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        summaryDataTable.rows().every(function () {
            const rowData = this.data();
            // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå "Sum Time" ‡∏ã‡∏∂‡πà‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà index 5 (‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏£‡∏∞‡∏ö‡∏∏)
            const sumTimeStr = rowData[5];
            const sumTimeValue = parseFloat(sumTimeStr);
            if (!isNaN(sumTimeValue)) {
                sumOfSumTime += sumTimeValue;
            }
        });

        if (totalCount > 0) {
            averageSumTime = sumOfSumTime / totalCount;
        }
    }

    const infoDiv = document.createElement("div");
    infoDiv.style.fontSize = "10px";
    infoDiv.style.marginBottom = "5px";
    infoDiv.style.marginTop = "5px";
    infoDiv.innerHTML = `
        üóìÔ∏è ‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà : ${startDateFormatted} - ${endDateFormatted}<br>
        üìä ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ôMesh : ${totalCount} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á | ‚è±Ô∏è AVG Sum Time : ${averageSumTime.toFixed(2)} ‡∏ä‡∏°.
    `;
    cont.append(infoDiv);
    // --- ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ ---
    const newTable = document.createElement("table");
    newTable.style.border = "1px solid #ccc";
    newTable.style.borderCollapse = "collapse";
    newTable.style.fontSize = "7px";

    const thead = document.createElement("thead");
    const headerRow = document.querySelector("#summaryTable thead tr").cloneNode(true);
    thead.appendChild(headerRow);
    newTable.appendChild(thead);

    const tbody = document.createElement("tbody");
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ summaryDataTable ‡∏ñ‡∏π‡∏Å initialize ‡πÅ‡∏•‡πâ‡∏ß
    if (summaryDataTable && summaryDataTable.rows().any()) { // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô DataTable
        summaryDataTable.rows().every(function () {
            const rowData = this.data();
            const tr = document.createElement("tr");
            rowData.forEach((cellData) => {
                const td = document.createElement("td");
                td.textContent = cellData;
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });
    } else {
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.setAttribute("colspan", "6");
        td.textContent = "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å";
        td.style.textAlign = "center";
        tr.appendChild(td);
        tbody.appendChild(tr);
    }
    newTable.appendChild(tbody);

    newTable.querySelectorAll("th, td").forEach((cell) => {
        cell.style.border = "1px solid #ccc";
        cell.style.padding = "4px 5px";
        cell.style.fontSize = "7px";
        cell.style.whiteSpace = "nowrap";
        cell.style.verticalAlign = "middle";
        cell.style.textAlign = "center";
    });

    cont.append(newTable);
    document.body.appendChild(cont);
    const canvas = await html2canvas(cont, {
        scale: 2,
    });
    document.body.removeChild(cont);
    return canvas;
}

      async function exportSummaryImage() {
    console.log("Attempting to export summary image...");
    const canvas = await generateSummaryImage();
    if (!canvas) {
        console.error("Canvas is null, cannot export summary image.");
        return;
    }

    const machineLetter = $('#machineLetterSelect').val();
    const machineNumber = $('#machineNumberSelect').val();
    const startDate = summaryStartDatePickerInstance ? summaryStartDatePickerInstance.input.value : 'N/A';

    let machinePart = '';
    if (machineLetter !== 'all' || machineNumber !== 'all') {
        machinePart = `${machineLetter === 'all' ? '' : machineLetter}${machineNumber === 'all' ? '' : machineNumber}_`;
    } else {
        machinePart = 'AllMachine_';
    }

    const filename = `SummaryRunTime_${machinePart}${startDate}.png`;
    const a = document.createElement("a");
    a.download = filename;
    a.href = canvas.toDataURL("image/png");
    a.click();
    console.log("Summary image export initiated.");
}

async function shareSummaryImage() {
    console.log("Attempting to share summary image...");
    const canvas = await generateSummaryImage();
    if (!canvas) {
        console.error("Canvas is null, cannot share summary image.");
        return;
    }

    const machineLetter = $('#machineLetterSelect').val();
    const machineNumber = $('#machineNumberSelect').val();
    const startDate = summaryStartDatePickerInstance ? summaryStartDatePickerInstance.input.value : 'N/A';
    const endDate = summaryEndDatePickerInstance ? summaryEndDatePickerInstance.input.value : 'N/A';

    let machineInfoForShare = '';
    if (machineLetter !== 'all' || machineNumber !== 'all') {
        machineInfoForShare = `Machine No: ${machineLetter === 'all' ? '' : machineLetter}${machineNumber === 'all' ? '' : machineNumber}`;
    } else {
        machineInfoForShare = 'Machine No: All';
    }

    const formatThaiDate = (dateStr) => {
        if (!dateStr || dateStr === 'N/A') return 'N/A';
        const parts = dateStr.split('-'); // YYYY-MM-DD
        if (parts.length === 3) {
            return `${parts[2]}/${parts[1]}/${parts[0]}`;
        }
        return dateStr;
    };

    const startDateFormatted = formatThaiDate(startDate);
    const endDateFormatted = formatThaiDate(endDate);

    let machinePart = '';
    if (machineLetter !== 'all' || machineNumber !== 'all') {
        machinePart = `${machineLetter === 'all' ? '' : machineLetter}${machineNumber === 'all' ? '' : machineNumber}_`;
    } else {
        machinePart = 'AllMachine_';
    }
    const filename = `SummaryRunTime_${machinePart}${startDate}.png`;

    try {
        const blob = await new Promise(resolve => canvas.toBlob(resolve, "image/png"));
        if (!blob) {
            throw new Error("Failed to create Blob from Canvas.");
        }
        const file = new File([blob], filename, {
            type: "image/png",
        });

        if (navigator.canShare && navigator.canShare({ files: [file] })) {
            await navigator.share({
                files: [file],
                title: "Run Time Summary Report",
                text: `Run Time Summary Report:\n${machineInfoForShare}\n‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${startDateFormatted} ‡∏ñ‡∏∂‡∏á ${endDateFormatted}`,
            });
            console.log("Summary image shared successfully.");
        } else {
            alert("‚ùå ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ú‡∏•‡∏£‡∏ß‡∏°' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î");
            console.warn("Web Share API not supported or cannot share files.");
        }
    } catch (error) {
        console.error("Error sharing summary image:", error);
    }
}

      $(async () => {
        // Initialize Flatpickr instances
        // Recent Table Date Picker
        recentDatePickerInstance = flatpickr("#recentDatePicker", {
            dateFormat: "Y-m-d", // Format matching Google Sheet (e.g., 2025-07-15)
            defaultDate: "today", // Sets default to current date
            locale: "th", // Use Thai localization if needed
            onChange: function(selectedDates, dateStr, instance) {
                updateRecentTableDisplay(); // Re-filter and display data
            }
        });

        // Summary Table Start Date Picker
        summaryStartDatePickerInstance = flatpickr("#summaryStartDatePicker", {
            dateFormat: "Y-m-d",
            defaultDate: new Date(new Date().getFullYear(), new Date().getMonth(), 1), // First day of current month
            locale: "th",
            onChange: function(selectedDates, dateStr, instance) {
                // Ensure end date is not before start date
                if (selectedDates.length > 0 && summaryEndDatePickerInstance.selectedDates.length > 0) {
                    if (summaryEndDatePickerInstance.selectedDates[0] < selectedDates[0]) {
                        summaryEndDatePickerInstance.setDate(selectedDates[0]);
                    }
                }
                calculateAndDisplaySummary();
            }
        });

        // Summary Table End Date Picker
        summaryEndDatePickerInstance = flatpickr("#summaryEndDatePicker", {
            dateFormat: "Y-m-d",
            defaultDate: "today", // Or last day of current month
            locale: "th",
            onChange: function(selectedDates, dateStr, instance) {
                 // Ensure start date is not after end date
                if (selectedDates.length > 0 && summaryStartDatePickerInstance.selectedDates.length > 0) {
                    if (summaryStartDatePickerInstance.selectedDates[0] > selectedDates[0]) {
                        summaryStartDatePickerInstance.setDate(selectedDates[0]);
                    }
                }
                calculateAndDisplaySummary();
            }
        });

        await loadData(); // Load data initially
        setInitialShift(); // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï recentTable
        calculateAndDisplaySummary(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï summaryTable ()

        $('input[name="shiftOption"]').on("change", updateRecentTableDisplay);
        $('#machineLetterSelect, #machineNumberSelect').on('change', calculateAndDisplaySummary);

        $("#exportSummaryImageBtn").on("click", exportSummaryImage);
        $("#shareSummaryImageBtn").on("click", shareSummaryImage);
        $("#exportRecentImageBtn").on("click", exportRecentImage);
        $("#shareRecentImageBtn").on("click", shareRecentImage);
      });
    </script>
  </body>
</html>
