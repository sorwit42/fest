<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Mesh</title>
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#2b6cb0" />
    <link rel="icon" type="image/png" sizes="32x32" href="/f/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/f/favicon-16x16.png" />
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <style>
      :root {
        --main-blue: #2b6cb0;
        --light-blue: #d0eaff;
        --bg: #f0f8ff;
        --white: #ffffff;
        --font: "Segoe UI", sans-serif;
      }
      body {
        font-family: var(--font);
        background: var(--bg);
        margin: 0;
        padding: 10px;
        box-sizing: border-box;
      }
      h2,
      h3 {
        color: var(--main-blue);
        margin-top: 20px;
      }
      button {
        padding: 12px;
        font-size: 1rem;
        background: #2b6cb0;
        color: white;
        border: none;
        border-radius: 8px;
        margin-top: 5px;
        margin-bottom: 15px;
        width: 48%;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: 0.2s ease-in-out;
      }
      button:hover {
        opacity: 0.9;
      }
      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        margin-bottom: 12px;
      }
      .controls label {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: bold;
        color: var(--main-blue);
      }
      .form-mini {
          width: 80px; /* Adjust as needed */
          padding: 8px;
          font-size: 0.9rem;
          border: 1px solid #ccc;
          border-radius: 4px;
          box-sizing: border-box; /* Include padding and border in the element's total width and height */
      }
      /* ‡πÑ‡∏°‡πà‡∏°‡∏µ form-mini ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö date pickers ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡πÅ‡∏•‡πâ‡∏ß, Flatpickr ‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á input ‡∏Ç‡∏≠‡∏á‡∏°‡∏±‡∏ô‡πÄ‡∏≠‡∏á */
      .form-control-date { /* ‡∏Ñ‡∏•‡∏≤‡∏™‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö input ‡∏Ç‡∏≠‡∏á Flatpickr */
        width: 150px; /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ */
        padding: 8px;
        font-size: 1rem;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      .form-control-date1 { /* ‡∏Ñ‡∏•‡∏≤‡∏™‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö input ‡∏Ç‡∏≠‡∏á Flatpickr */
        width: 150px; /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ */
        padding: 8px;
        font-size: 1rem;
        border: 1px solid #ccc;
        border-radius: 4px;
      }

      .table-wrapper {
        overflow-x: auto;
        background: var(--white);
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
        margin-top: 5px;
        margin-bottom: 10px;
        font-size: 0.8rem;
        resize: both;
        min-width: 348px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
        font-size: 0.7rem;
      }

      th,
      td {
        border: 1px solid #ccc;
        padding: 4px 2px;
        text-align: center;
        white-space: nowrap;
        vertical-align: middle;
      }
      th {
        background: var(--light-blue);
      }
      .average-row {
        background: #d0eaff !important;
        font-weight: bold;
      }

      .date-input-group {
        display: flex;
        gap: 15px;
        
        margin-right: 10px;
      }

      .date-input-group label {
        font-weight: bold;
        color: var(--main-blue);
        margin-bottom: 0;
        white-space: nowrap;
      }

      @media (max-width: 480px) {
        .controls {
          flex-direction: column;
        }
          .date-input-group {
    width: 100%; /* ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á */
    margin-right: 0; /* ‡∏•‡∏ö margin ‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤‡∏≠‡∏≠‡∏Å */
  }
  .form-control-date {
    width: 100%; /* input ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á */
  }
        table {
          font-size: 0.6rem;
          min-width: 320px;
        }
        th,
        td {
          padding: 3px 1px;
        }
        .form-control-date { /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
          width: 30%;
        }
                .form-control-date1 { /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
          width: 30%;
        }
      }
      th.machine-date {
        width: 60px;
      }
      th. {
        width: 60px;
      }
      th.reject-col {
        width: 60px;
      }
      th.cycleshift-col {
        width: 60px;
      }
      th.cycletime-col {
        width: 60px;
      }
      th.runtime-col {
        width: 60px;
      }
      th.trim-col {
        width: 60px;
      }
      th.shift-col {
        width: 60px;
      }
      th {
        text-align: center;
        padding: 4px;
      }
      td {
        text-align: center;
        padding: 2px;
      }
      input.table-input {
        width: 50px;
        text-align: right;
      }

      .share-export-buttons {
          margin-top: 10px;
          text-align: center; /* Center buttons */
          display: flex;
          justify-content: center;
          gap: 10px; /* Space between buttons */
          flex-wrap: wrap; /* Allow buttons to wrap on smaller screens */
      }
      .share-export-buttons button {
          width: auto; /* Adjust button width */
          flex-grow: 1; /* Allow buttons to grow and fill space */
          max-width: 200px; /* Max width for buttons */
      }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/th.js"></script>

  </head>
  <body>
    <button onclick="window.location.href='/index.html?i=1'">üè† ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
    <button onclick="window.location.href='/report.html?i=1'">üìä ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</button>
    <button onclick="window.location.href='/summary.html?i=1'">üìÑ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    <button onclick="window.location.href='/running.html?i=1'">‚è≥ Running Time</button>
   
    <h2 style="margin-top: 15px; font-size: 20px;">‡∏ú‡∏•‡∏£‡∏ß‡∏° Run Time ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Mesh Status</h2>
    <div class="controls">
        <label>
            ‚öôÔ∏è ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á:
            <select id="machineLetterSelect" class="form-mini">
                <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
            </select>
            <select id="machineNumberSelect" class="form-mini">
                <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
            </select>
        </label>
        <div class="date-input-group">
            <label for="summaryStartDatePicker">üóìÔ∏è ‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô:</label>
            <label for="summaryEndDatePicker">üóìÔ∏è ‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>            
        </div>
        <div class="date-input-group">
            <input type="text" id="summaryStartDatePicker" class="form-control-date" />
            <input type="text" id="summaryEndDatePicker" class="form-control-date" />
        </div>
    </div>
    <div class="table-wrapper">
        <table id="summaryTable">
            <thead>
                <tr>
                    <th class="machine-date">Date</th>
                    <th>Machine</th>
                    <th>RunTime</th>
                    <th>Shift</th>
                    <th>Status</th>
                    <th>Sum Time</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <div class="share-export-buttons">
            <button id="shareSummaryImageBtn" class="btn btn-info btn-sm"> > üì§ ‡πÅ‡∏ä‡∏£‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
            </button>
            <button id="exportSummaryImageBtn" class="btn btn-primary btn-sm"> üì∑ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
            </button>
        </div>
    </div>


    <script>
        let allData = [];
        let summaryDataTable; // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö summaryTable

        // Global Flatpickr instances for easy access
        let summaryStartDatePickerInstance;
        let summaryEndDatePickerInstance;

        async function loadData() {
            try {
                // *** ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢ API Key ‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ***
                const apiKey = "AIzaSyB_Jrjw4_H6qm4QTUUSCcz5z2A7xGL_dAQ"; // <--- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ!
                const spreadsheetId = "1Nmcrwydbke_qMdMqYEH2Mk85MQzy3bsRQVSfLKP5Edw"; // Replace with your actual Spreadsheet ID
                const range = "Cycle_Time!A2:L"; // Adjust range if your data changes

                const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${range}?key=${apiKey}`;
                
                const res = await fetch(url);
                if (!res.ok) {
                    const errorText = await res.text();
                    throw new Error(`HTTP error! status: ${res.status}, Message: ${errorText}`);
                }
                const json = await res.json();
                allData = json.values || [];
                console.log("All data loaded:", allData);
            } catch (error) {
                console.error("Error loading data from Google Sheets:", error);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö API Key, ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå Google Sheet, ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏à‡∏≤‡∏Å API Console");
                $("#summaryTable tbody").html('<tr><td colspan="6">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö API Key ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google Sheet</td></tr>');
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏£‡∏ß‡∏° Run Time ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Mesh Status ("Yes")
        function calculateAndDisplaySummary() {
            const summaryData = [];
            const machineLetter = $('#machineLetterSelect').val();
            const machineNumber = $('#machineNumberSelect').val();
            
            // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å Flatpickr, ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ instances ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
            const startDate = summaryStartDatePickerInstance ? summaryStartDatePickerInstance.input.value : null;
            const endDate = summaryEndDatePickerInstance ? summaryEndDatePickerInstance.input.value : null;

            // ‡∏´‡∏≤‡∏Å startDate ‡∏´‡∏£‡∏∑‡∏≠ endDate ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
            if (!startDate || !endDate) {
                console.warn("Start or End date is missing for summary table. Cannot calculate summary.");
                $("#summaryTable tbody").html('<tr><td colspan="6">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå</td></tr>');
                // ‡∏ó‡∏≥‡∏•‡∏≤‡∏¢ DataTable ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô error
                if ($.fn.DataTable.isDataTable("#summaryTable")) {
                    summaryDataTable.destroy();
                    $("#summaryTable tbody").empty();
                }
                return; // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ñ‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå
            }
            console.log(`Calculating Summary for: Start Date: ${startDate}, End Date: ${endDate}, Machine: ${machineLetter}${machineNumber}`);


            // 1. ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏° Machine ‡πÅ‡∏•‡∏∞ Date Range
            let filteredDataForSummary = allData.filter((r) => {
                const rowDate = r[0]; // Column A: Date (assuming YYYY-MM-DD format from sheet)
                const rowMachine = r[2]; // Column C: Mac

                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤ rowDate ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà undefined/null ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö
                if (!rowDate) return false;

                const dateMatch = (rowDate >= startDate && rowDate <= endDate);

                let machineMatch = true;
                if (machineLetter !== 'all' && machineNumber !== 'all') {
                    machineMatch = (rowMachine === `${machineLetter}${machineNumber}`);
                } else if (machineLetter !== 'all') {
                    machineMatch = (rowMachine && rowMachine.startsWith(machineLetter));
                } else if (machineNumber !== 'all') {
                    machineMatch = (rowMachine && rowMachine.endsWith(machineNumber));
                }
                return dateMatch && machineMatch;
            });

            // Sort data for correct sequence-based summation
            filteredDataForSummary.sort((a, b) => {
                const dateA = a[0];
                const dateB = b[0];
                if (dateA !== dateB) return dateA.localeCompare(dateB);

                const machineA = a[2];
                const machineB = b[2];
                if (machineA !== machineB) return machineA.localeCompare(machineB);
                
                const shiftOrder = {"‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤": 1, "‡∏Å‡∏∞‡∏ö‡πà‡∏≤‡∏¢": 2, "‡∏Å‡∏∞‡∏î‡∏∂‡∏Å": 3, "all": 4, "": 5};
                const shiftA = a[8] || "";
                const shiftB = b[8] || "";
                if (shiftOrder[shiftA] !== shiftOrder[shiftB]) {
                    return shiftOrder[shiftA] - shiftOrder[shiftB];
                }
                return 0;
            });


            // 2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Sum Run ‡∏ï‡∏≤‡∏°‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏°‡∏≤
            let currentSumRun = 0;
            let segmentData = [];
            const displayRows = [];

            for (let i = 0; i < filteredDataForSummary.length; i++) {
                const row = filteredDataForSummary[i];
                const runTime = parseFloat(row[6]) || 0; // Column G
                const meshStatus = row[9]; // Column J

                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡πÉ‡∏ô segmentData ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏°‡∏≠
                segmentData.push({
                    date: row[0],
                    machine: row[2],
                    runTime: runTime,
                    shift: row[8],
                    meshStatus: meshStatus
                });
                currentSumRun += runTime;

                // ‡∏ñ‡πâ‡∏≤ Mesh Status ‡πÄ‡∏õ‡πá‡∏ô "Yes" ‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏£‡∏ß‡∏°‡πÅ‡∏•‡∏∞‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
                if (meshStatus === "Yes") {
                    const lastRowInSegment = segmentData[segmentData.length - 1]; // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î "Yes"
                    displayRows.push([
                        lastRowInSegment.date,
                        lastRowInSegment.machine,
                        lastRowInSegment.runTime.toFixed(2), // ‡πÅ‡∏™‡∏î‡∏á Run Time ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏ß‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î "Yes"
                        lastRowInSegment.shift,
                        lastRowInSegment.meshStatus,
                        currentSumRun.toFixed(2) // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏£‡∏ß‡∏° Run Time ‡∏Ç‡∏≠‡∏á segment
                    ]);
                    
                    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö segment ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                    currentSumRun = 0;
                    segmentData = [];
                }
            }
            console.log("Summary Display Rows:", displayRows);
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡∏•‡∏≤‡∏¢ DataTable ‡πÄ‡∏Å‡πà‡∏≤
            if ($.fn.DataTable.isDataTable("#summaryTable")) {
                summaryDataTable.destroy();
                $("#summaryTable tbody").empty();
            }

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á DataTable ‡πÉ‡∏´‡∏°‡πà
            summaryDataTable = $("#summaryTable").DataTable({
                data: displayRows,
                columns: [
                    { title: "Date", data: 0 },
                    { title: "Machine", data: 1 },
                    { title: "RunTime", data: 2 },
                    { title: "Shift", data: 3 },
                    { title: "Status", data: 4 },
                    { title: "Sum Time", data: 5 },
                ],
                paging: false,
                searching: false,
                info: false,
                order: [[0, "asc"], [1, "asc"], [3, "asc"]],
            });
        }


        async function generateSummaryImage() {
            const cont = document.createElement("div");
            cont.style.padding = "20px";
            cont.style.background = "#fff";
            cont.style.fontFamily = "sans-serif";
            cont.style.width = "fit-content";
            cont.style.display = "inline-block";

            const h = document.createElement("h3");
            h.textContent = "‡∏ú‡∏•‡∏£‡∏ß‡∏° Run Time ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Mesh Status";
            h.style.marginTop = "5px";
            h.style.marginBottom = "5px";
            h.style.fontSize = "17px";
            h.style.color = "#2b6cb0";
            cont.append(h);

            // --- ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Machine No. ‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ---
            const machineLetter = $('#machineLetterSelect').val();
            const machineNumber = $('#machineNumberSelect').val();
            const startDate = summaryStartDatePickerInstance ? summaryStartDatePickerInstance.input.value : 'N/A';
            const endDate = summaryEndDatePickerInstance ? summaryEndDatePickerInstance.input.value : 'N/A';

            let machineInfo = '';
            if (machineLetter !== 'all' || machineNumber !== 'all') {
                machineInfo = `${machineLetter === 'all' ? '' : machineLetter}${machineNumber === 'all' ? '' : machineNumber}`;
            } else {
                machineInfo = 'All';
            }

            const h2 = document.createElement("h2");
            h2.textContent = `Machine No : ${machineInfo}`;
            h2.style.marginTop = "2px";
            h2.style.marginBottom = "2px";
            h2.style.fontSize = "13px";
            h2.style.color = "#2b6cb0";
            cont.append(h2);

            // Convert dates to DD/MM/YYYY for display
            const formatThaiDate = (dateStr) => {
                if (!dateStr || dateStr === 'N/A') return 'N/A';
                const parts = dateStr.split('-'); // YYYY-MM-DD
                if (parts.length === 3) {
                    return `${parts[2]}/${parts[1]}/${parts[0]}`;
                }
                return dateStr;
            };

            const startDateFormatted = formatThaiDate(startDate);
            const endDateFormatted = formatThaiDate(endDate);

            // --- ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡πÅ‡∏•‡∏∞ ‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏Ç‡∏≠‡∏á "Sum Time" ---
            let totalCount = 0;
            let sumOfSumTime = 0;
            let averageSumTime = 0;

            if (summaryDataTable && summaryDataTable.rows().any()) {
                totalCount = summaryDataTable.rows().count();
                summaryDataTable.rows().every(function () {
                    const rowData = this.data();
                    const sumTimeStr = rowData[5];
                    const sumTimeValue = parseFloat(sumTimeStr);
                    if (!isNaN(sumTimeValue)) {
                        sumOfSumTime += sumTimeValue;
                    }
                });

                if (totalCount > 0) {
                    averageSumTime = sumOfSumTime / totalCount;
                }
            }

            const infoDiv = document.createElement("div");
            infoDiv.style.fontSize = "10px";
            infoDiv.style.marginBottom = "5px";
            infoDiv.style.marginTop = "5px";
            infoDiv.innerHTML = `
                üóìÔ∏è ‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà : ${startDateFormatted} - ${endDateFormatted}<br>
                üìä ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ôMesh : ${totalCount} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á | ‚è±Ô∏è AVG Sum Time : ${averageSumTime.toFixed(2)} ‡∏ä‡∏°.
            `;
            cont.append(infoDiv);
            // --- ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ ---
            const newTable = document.createElement("table");
            newTable.style.border = "1px solid #ccc";
            newTable.style.borderCollapse = "collapse";
            newTable.style.fontSize = "7px";

            const thead = document.createElement("thead");
            const headerRow = document.querySelector("#summaryTable thead tr").cloneNode(true);
            thead.appendChild(headerRow);
            newTable.appendChild(thead);

            const tbody = document.createElement("tbody");
            if (summaryDataTable && summaryDataTable.rows().any()) {
                summaryDataTable.rows().every(function () {
                    const rowData = this.data();
                    const tr = document.createElement("tr");
                    rowData.forEach((cellData) => {
                        const td = document.createElement("td");
                        td.textContent = cellData;
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                });
            } else {
                const tr = document.createElement("tr");
                const td = document.createElement("td");
                td.setAttribute("colspan", "6");
                td.textContent = "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å";
                td.style.textAlign = "center";
                tr.appendChild(td);
                tbody.appendChild(tr);
            }
            newTable.appendChild(tbody);

            newTable.querySelectorAll("th, td").forEach((cell) => {
                cell.style.border = "1px solid #ccc";
                cell.style.padding = "4px 5px";
                cell.style.fontSize = "7px";
                cell.style.whiteSpace = "nowrap";
                cell.style.verticalAlign = "middle";
                cell.style.textAlign = "center";
            });

            cont.append(newTable);
            document.body.appendChild(cont);
            const canvas = await html2canvas(cont, {
                scale: 2,
            });
            document.body.removeChild(cont);
            return canvas;
        }

        async function exportSummaryImage() {
            console.log("Attempting to export summary image...");
            const canvas = await generateSummaryImage();
            if (!canvas) {
                console.error("Canvas is null, cannot export summary image.");
                return;
            }

            const machineLetter = $('#machineLetterSelect').val();
            const machineNumber = $('#machineNumberSelect').val();
            const startDate = summaryStartDatePickerInstance ? summaryStartDatePickerInstance.input.value : 'N/A';

            let machinePart = '';
            if (machineLetter !== 'all' || machineNumber !== 'all') {
                machinePart = `${machineLetter === 'all' ? '' : machineLetter}${machineNumber === 'all' ? '' : machineNumber}_`;
            } else {
                machinePart = 'AllMachine_';
            }

            const filename = `SummaryRunTime_${machinePart}${startDate}.png`;
            const a = document.createElement("a");
            a.download = filename;
            a.href = canvas.toDataURL("image/png");
            a.click();
            console.log("Summary image export initiated.");
        }

        async function shareSummaryImage() {
            console.log("Attempting to share summary image...");
            const canvas = await generateSummaryImage();
            if (!canvas) {
                console.error("Canvas is null, cannot share summary image.");
                return;
            }

            const machineLetter = $('#machineLetterSelect').val();
            const machineNumber = $('#machineNumberSelect').val();
            const startDate = summaryStartDatePickerInstance ? summaryStartDatePickerInstance.input.value : 'N/A';
            const endDate = summaryEndDatePickerInstance ? summaryEndDatePickerInstance.input.value : 'N/A';

            let machineInfoForShare = '';
            if (machineLetter !== 'all' || machineNumber !== 'all') {
                machineInfoForShare = `Machine No: ${machineLetter === 'all' ? '' : machineLetter}${machineNumber === 'all' ? '' : machineNumber}`;
            } else {
                machineInfoForShare = 'Machine No: All';
            }

            const formatThaiDate = (dateStr) => {
                if (!dateStr || dateStr === 'N/A') return 'N/A';
                const parts = dateStr.split('-'); // YYYY-MM-DD
                if (parts.length === 3) {
                    return `${parts[2]}/${parts[1]}/${parts[0]}`;
                }
                return dateStr;
            };

            const startDateFormatted = formatThaiDate(startDate);
            const endDateFormatted = formatThaiDate(endDate);

            let machinePart = '';
            if (machineLetter !== 'all' || machineNumber !== 'all') {
                machinePart = `${machineLetter === 'all' ? '' : machineLetter}${machineNumber === 'all' ? '' : machineNumber}_`;
            } else {
                machinePart = 'AllMachine_';
            }
            const filename = `SummaryRunTime_${machinePart}${startDate}.png`;

            try {
                const blob = await new Promise(resolve => canvas.toBlob(resolve, "image/png"));
                if (!blob) {
                    throw new Error("Failed to create Blob from Canvas.");
                }
                const file = new File([blob], filename, {
                    type: "image/png",
                });

                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    await navigator.share({
                        files: [file],
                        title: "Run Time Summary Report",
                        text: `Run Time Summary Report:\n${machineInfoForShare}\n‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${startDateFormatted} ‡∏ñ‡∏∂‡∏á ${endDateFormatted}`,
                    });
                    console.log("Summary image shared successfully.");
                } else {
                    alert("‚ùå ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ú‡∏•‡∏£‡∏ß‡∏°' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î");
                    console.warn("Web Share API not supported or cannot share files.");
                }
            } catch (error) {
                console.error("Error sharing summary image:", error);
            }
        }

        $(async () => {
            // Initialize Flatpickr instances
            summaryStartDatePickerInstance = flatpickr("#summaryStartDatePicker", {
                dateFormat: "Y-m-d",
                defaultDate: new Date(new Date().getFullYear(), new Date().getMonth(), 1), // First day of current month
                locale: "th",
                onChange: function(selectedDates, dateStr, instance) {
                    if (selectedDates.length > 0 && summaryEndDatePickerInstance.selectedDates.length > 0) {
                        if (summaryEndDatePickerInstance.selectedDates[0] < selectedDates[0]) {
                            summaryEndDatePickerInstance.setDate(selectedDates[0]);
                        }
                    }
                    calculateAndDisplaySummary();
                }
            });

            summaryEndDatePickerInstance = flatpickr("#summaryEndDatePicker", {
                dateFormat: "Y-m-d",
                defaultDate: "today", // Or last day of current month
                locale: "th",
                onChange: function(selectedDates, dateStr, instance) {
                    if (selectedDates.length > 0 && summaryStartDatePickerInstance.selectedDates.length > 0) {
                        if (summaryStartDatePickerInstance.selectedDates[0] > selectedDates[0]) {
                            summaryStartDatePickerInstance.setDate(selectedDates[0]);
                        }
                    }
                    calculateAndDisplaySummary();
                }
            });

            await loadData(); // Load data initially
            calculateAndDisplaySummary(); // Update summaryTable after data is loaded and Flatpickr is initialized

            $('#machineLetterSelect, #machineNumberSelect').on('change', calculateAndDisplaySummary);

            $("#exportSummaryImageBtn").on("click", exportSummaryImage);
            $("#shareSummaryImageBtn").on("click", shareSummaryImage);
        });
    </script>
  </body>
</html>
