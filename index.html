<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8">
    <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Cycle Time</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#2b6cb0">
    <link rel="icon" type="image/png" sizes="32x32" href="/f/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/f/favicon-16x16.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(to bottom right, #e0f2ff, #ffffff);
            padding: 16px;
            margin: 0;
            color: #333;
        }
        h2 {
            font-size: 1.4rem;
            margin-bottom: 10px;
            text-align: left;
            color: #1f5491;
        }
        fieldset {
            border: 1px solid #b3d4fc;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            background: #ffffffee;
            box-shadow: 0 0 6px rgba(0,0,0,0.05);
            position: relative;
            transition: border-color 0.3s ease;
        }
        /* ‡∏ã‡πà‡∏≠‡∏ô fieldset ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô */
        #machine-fieldset,
        #data-fieldset {
            display: none;
        }

        fieldset.error-border {
            border: 2px solid #e53e3e;
        }
        legend {
            font-weight: bold;
            font-size: 1rem;
            color: #2b6cb0;
        }
        label {
            font-size: 0.9rem;
        }
        .machine-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            margin-bottom: 10px;
        }
        .machine-grid label {
            background: #d0eaff;
            padding: 4px 6px;
            border-radius: 4px;
            text-align: center;
            display: block;
            font-size: 0.85rem;
        }
        .shift-row {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 12px;
            padding-top: 4px;
        }
        .shift-row label {
            background: #d0eaff;
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
        }
        table {
            width: 100%;
            table-layout: fixed;
            border-collapse: collapse;
            font-size: 0.80rem;
            background: #fff;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 4px;
            text-align: center;
            vertical-align: middle;
        }

        /* --- ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á TH ‡πÅ‡∏•‡∏∞ TD ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà (‡∏£‡∏ß‡∏° 7 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå) --- */
        th.col-macno, td.col-macno { width: 15%; } /* MacNo. */
        th.col-rejs, td.col-rejs { width: 20%; } /* Rejs */
        th.col-cycshf, td.col-cycshf { width: 10%; } /* Cyc Shf */
        th.col-cyctime, td.col-cyctime { width: 15%; } /* Cyc Time */
        th.col-status-short, td.col-status-short { width: 15%; } /* ‡∏¢‡∏Å‡∏•‡πâ‡∏≤‡∏á*/
        th.col-fmrob, td.col-fmrob { width: 10%; } /* FM&Rob */

        input[type="number"] {
            width: 90%;
            max-width: 80px;
            font-size: 0.9rem;
            border: 1px solid #ccc;
            padding: 4px;
            border-radius: 4px;
            box-sizing: border-box;
        }

        input[type="number"]:disabled {
            background-color: #f0f0f0;
            cursor: not-allowed;
        }

        .small-input {
          max-width: 60px;
        }
        .medium-input {
          max-width: 80px;
        }

        .form-check {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
        }
        .form-check input[type="checkbox"] {
            margin: 0;
            transform: scale(1.2);
        }
        .form-check input[type="checkbox"]:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        button {
            padding: 12px;
            font-size: 1rem;
            background: #2b6cb0;
            color: white;
            border: none;
            border-radius: 8px;
            margin-top: 12px;
            width: 48%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: 0.2s ease-in-out;
        }
        button:hover {
            background: #1f5491;
        }
        .button-row {
            display: flex;
            gap: 4%;
            flex-wrap: wrap;
            justify-content: center;
        }
        #loadingMessage {
            display: none;
            text-align: center;
            margin-top: 10px;
            font-size: 1rem;
            font-weight: bold;
            color: #2b6cb0;
        }
        .loading-dot {
            display: inline-block;
            animation: blink 1s infinite;
        }
        .loading-dot:nth-child(2) { animation-delay: 0.2s; }
        .loading-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes blink {
            0%, 100% { opacity: 0.2; }
            50% { opacity: 1; }
        }
        /* Style for disabled checkboxes */
        .machine-grid input[type="checkbox"]:disabled + label {
            background-color: #e0e0e0;
            color: #888;
            cursor: not-allowed;
            text-decoration: line-through;
        }

        /* Styles for alert messages */
        .alert-message {
            text-align: center;
            color: #e53e3e;
            font-weight: bold;
            font-size: 0.7rem;
            margin-top: 5px;
        }

        /* --- Responsive Design ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏•‡πá‡∏Å) --- */
        @media (max-width: 600px) {
            .controls {
                flex-direction: column;
            }
            th, td {
            border: 1px solid #ccc;
            padding: 4px;
            text-align: center;
            font-size: 0.7rem;
            vertical-align: middle;
            margin-top: 5px;
        }
            /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å */
            th.col-macno, td.col-macno { width: 12%; }
            th.col-rejs, td.col-rejs { width: 13%; }
            th.col-cycshf, td.col-cycshf { width: 15%; }
            th.col-cyctime, td.col-cyctime { width: 15%; }
            th.col-status-short, td.col-status-short { width: 15%; }
            th.col-fmrob, td.col-fmrob { width: 15%; }

            input[type="number"] {
                width: 100%;
                max-width: 60px;
            }
            .small-input {
                max-width: 45px;
            }
            .medium-input {
                max-width: 55px;
            }
            table {
                font-size: 0.7rem;
            }
        }
    </style>
    <script>
        let allSheetDataCache = [];
        let lastFetchDate = '';
        let lastFetchShift = '';
        let duplicateMachineIds = new Set();

        function machineSort(a, b) {
            const re = /^([A-Za-z]+)(\d+)$/;
            const matchA = a.match(re);
            const matchB = b.match(re);

            if (!matchA || !matchB) {
                return a.localeCompare(b);
            }

            const [_, charA, numA] = matchA;
            const [__, charB, numB] = matchB;

            if (charA === charB) {
                return parseInt(numA) - parseInt(numB);
            }
            return charA.localeCompare(charB);
        }

        function toggleInputs(id, data = null) {
            const row = document.getElementById('inputs-' + id);
            const cb = document.getElementById('cb-' + id);
            const isChecked = cb.checked;

            const rejectsInput = document.getElementById(`rejects-${id}`);
            const cycleShiftInput = document.getElementById(`cycleshift-${id}`);
            const cycleTimeInput = document.getElementById(`cycletime-${id}`);
            const moldCheckbox = document.getElementById(`mold-status-${id}`);
            const meshCheckbox = document.getElementById(`mesh-status-${id}`);
            const fmrobCheckbox = document.getElementById(`fmrob-status-${id}`);

            if (row) {
                if (isChecked) {
                    row.style.display = '';
                    if (data) {
                        rejectsInput.value = data.rejects || '';
                        cycleShiftInput.value = data.cycleShift || '';
                        cycleTimeInput.value = data.cycleTime || '';
                        moldCheckbox.checked = (data.moldStatus === 'Yes');
                        meshCheckbox.checked = (data.meshStatus === 'Yes');
                        fmrobCheckbox.checked = (data.fmrobStatus === 'Yes');

                        rejectsInput.disabled = true;
                        cycleShiftInput.disabled = true;
                        cycleTimeInput.disabled = true;
                        moldCheckbox.disabled = true;
                        meshCheckbox.disabled = true;
                        fmrobCheckbox.disabled = true;
                    } else {
                        rejectsInput.value = '';
                        cycleShiftInput.value = '';
                        cycleTimeInput.value = '';
                        moldCheckbox.checked = false;
                        meshCheckbox.checked = false;
                        fmrobCheckbox.checked = false;

                        rejectsInput.disabled = false;
                        cycleShiftInput.disabled = false;
                        cycleTimeInput.disabled = false;
                        moldCheckbox.disabled = false;
                        meshCheckbox.disabled = false;
                        fmrobCheckbox.disabled = false;
                    }
                } else {
                    row.style.display = 'none';
                    rejectsInput.value = '';
                    cycleShiftInput.value = '';
                    cycleTimeInput.value = '';
                    moldCheckbox.checked = false;
                    meshCheckbox.checked = false;
                    fmrobCheckbox.checked = false;

                    rejectsInput.disabled = false;
                    cycleShiftInput.disabled = false;
                    cycleTimeInput.disabled = false;
                    moldCheckbox.disabled = false;
                    meshCheckbox.disabled = false;
                    fmrobCheckbox.disabled = false;
                }

                if (cb.disabled && !cb.checked) {
                     row.style.display = 'none';
                }
                // Check and clear data input alert when inputs are toggled
                checkDataInputCompletionAndHideAlert();
            }
        }

        function clearCheckboxes() {
            document.querySelectorAll('.machine-grid input[type="checkbox"]').forEach(cb => {
                const machineId = cb.id.replace('cb-', '');
                const row = document.getElementById(`inputs-${machineId}`);

                if (cb.disabled) {
                    cb.checked = false;
                    if (row) {
                        row.style.display = 'none';
                    }
                } else {
                    cb.checked = false;
                    toggleInputs(machineId);
                }
            });

            document.querySelectorAll('input[type="number"]').forEach(input => {
                const machineId = input.id.split('-')[1];
                const cb = document.getElementById(`cb-${machineId}`);
                if (!cb.disabled) {
                    input.value = '';
                    input.disabled = false;
                }
            });
            document.querySelectorAll('input[type="checkbox"][id^="mold-status-"], input[type="checkbox"][id^="mesh-status-"], input[type="checkbox"][id^="fmrob-status-"]').forEach(inputCb => {
                const machineId = inputCb.id.split('-')[1];
                const cb = document.getElementById(`cb-${machineId}`);
                if (!cb.disabled) {
                    inputCb.checked = false;
                    inputCb.disabled = false;
                }
            });

            duplicateMachineIds.clear();

            // Clear any error messages and borders
            document.getElementById('shift-fieldset').classList.remove('error-border');
            document.getElementById('shift-alert-message').textContent = '';
            document.getElementById('machine-fieldset').classList.remove('error-border');
            document.getElementById('machine-alert-message').textContent = '';
            document.getElementById('data-fieldset').classList.remove('error-border');
            document.getElementById('data-alert-message').textContent = '';
        }

        function toggleMoldStatusCheckbox(id) {
            const moldCheckbox = document.getElementById(`mold-status-${id}`);
            const meshCheckbox = document.getElementById(`mesh-status-${id}`);
            if (moldCheckbox.checked) {
                meshCheckbox.checked = true;
            } else {
                meshCheckbox.checked = false;
            }
            checkDataInputCompletionAndHideAlert();
        }

        function checkMachineSelectionAndHideAlert() {
            const machineFieldset = document.getElementById('machine-fieldset');
            const machineAlertMessage = document.getElementById('machine-alert-message');
            const selectedMachines = Array.from(document.querySelectorAll('.machine-grid input[type="checkbox"]:checked:not(:disabled)'));

            if (selectedMachines.length > 0) {
                machineFieldset.classList.remove('error-border');
                machineAlertMessage.textContent = '';
            }
        }

        function checkDataInputCompletionAndHideAlert() {
            const dataFieldset = document.getElementById('data-fieldset');
            const dataAlertMessage = document.getElementById('data-alert-message');

            const activeMachineRows = document.querySelectorAll('tbody tr[id^="inputs-"]:not([style*="display: none"])');
            let allDataComplete = true;

            activeMachineRows.forEach(row => {
                const machineId = row.id.replace('inputs-', '');
                const cb = document.getElementById(`cb-${machineId}`);

                if (cb.checked && !cb.disabled) {
                    const rejectsInput = document.getElementById(`rejects-${machineId}`);
                    const cycleShiftInput = document.getElementById(`cycleshift-${machineId}`);
                    const cycleTimeInput = document.getElementById(`cycletime-${machineId}`);

                    if (rejectsInput.value.trim() === '' ||
                        cycleShiftInput.value.trim() === '' ||
                        cycleTimeInput.value.trim() === '') {
                        allDataComplete = false;
                    }
                }
            });

            if (allDataComplete) {
                dataFieldset.classList.remove('error-border');
                dataAlertMessage.textContent = '';
            }
        }

        async function submitData() {
            const shiftRadio = document.querySelector('input[name="shift"]:checked');
            const shiftFieldset = document.getElementById('shift-fieldset');
            const shiftAlertMessage = document.getElementById('shift-alert-message');
            const machineFieldset = document.getElementById('machine-fieldset');
            const machineAlertMessage = document.getElementById('machine-alert-message');
            const dataFieldset = document.getElementById('data-fieldset');
            const dataAlertMessage = document.getElementById('data-alert-message');

            // Reset error states for all fieldsets
            shiftFieldset.classList.remove('error-border');
            shiftAlertMessage.textContent = '';
            machineFieldset.classList.remove('error-border');
            machineAlertMessage.textContent = '';
            dataFieldset.classList.remove('error-border');
            dataAlertMessage.textContent = '';

            // 1. Check Shift Selection
            if (!shiftRadio) {
                shiftAlertMessage.textContent = "‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏∞‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö";
                shiftFieldset.classList.add('error-border');
                return;
            }
            const shift = shiftRadio.value;

            // 2. Check Machine Selection
            const selected = Array.from(document.querySelectorAll('.machine-grid input[type="checkbox"]:checked:not(:disabled)'));

            if (selected.length === 0) {
                machineAlertMessage.textContent = "‚ö†Ô∏è ‡πÇ‡∏≠‡πä‡∏∞! ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å";
                machineFieldset.classList.add('error-border');
                return;
            }

            // 3. Check Data Input Completion for selected machines
            let incompleteDataMachineIds = [];
            selected.forEach(cb => {
                const id = cb.id.replace('cb-', '');
                const rejectsInput = document.getElementById(`rejects-${id}`);
                const cycleShiftInput = document.getElementById(`cycleshift-${id}`);
                const cycleTimeInput = document.getElementById(`cycletime-${id}`);

                if (rejectsInput.value.trim() === '' ||
                    cycleShiftInput.value.trim() === '' ||
                    cycleTimeInput.value.trim() === '') {
                    incompleteDataMachineIds.push(id);
                }
            });

            if (incompleteDataMachineIds.length > 0) {
                const formattedMachineIds = incompleteDataMachineIds.sort(machineSort).join(', ');
                dataAlertMessage.innerHTML = `‚ö†Ô∏è ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á <span style="color: blue;">${formattedMachineIds}</span> ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö`;
                dataFieldset.classList.add('error-border');
                return;
            }

            document.getElementById("loadingMessage").style.display = "block";
            document.getElementById("loadingMessage").innerHTML = `
                ‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö <span class="loading-dot">.</span><span class="loading-dot">.</span><span class="loading-dot">.</span>
            `;

            try {
                const fetchPromises = selected.map(async (cb) => {
                    const id = cb.id.replace('cb-', '');

                    const rejectsInput = document.getElementById('rejects-' + id);
                    if (rejectsInput.disabled) {
                        console.log(`Skipping submission for machine ${id} as its inputs are disabled (data already exists).`);
                        return Promise.resolve();
                    }

                    const rejects = rejectsInput?.value || 0;
                    const cycleShift = parseFloat(document.getElementById('cycleshift-' + id)?.value) || 0;
                    const cycleTime = parseFloat(document.getElementById('cycletime-' + id)?.value) || 0;

                    const meshStatus = document.getElementById(`mesh-status-${id}`).checked ? "Yes": "";
                    const moldStatus = document.getElementById(`mold-status-${id}`).checked ? "Yes": "";
                    const fmrobStatus = document.getElementById(`fmrob-status-${id}`).checked ? "Yes": "";

                    const data = {
                        machine: id,
                        shift,
                        rejects,
                        cycleShift,
                        cycleTime,
                        meshStatus,
                        moldStatus,
                        fmrobStatus
                    };

                    console.log(`Sending data for machine ${id}:`, data);

                    const response = await fetch('https://script.google.com/macros/s/AKfycbzohstjwQfKMLxNzdXCWP7yFqpq3Dm3ZPimw5kRvk3OAu55W8QnJ3cIsXqUS71KDuoo/exec', {
                        method: 'POST',
                        body: JSON.stringify(data),
                        headers: {
                            'Content-Type': 'text/plain;charset=utf-8'
                        },
                        redirect: 'follow'
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                    }
                    return response;
                });

                await Promise.all(fetchPromises);

                document.getElementById("loadingMessage").innerHTML = "‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö!";
                setTimeout(() => {
                    document.getElementById("loadingMessage").style.display = "none";
                    clearCheckboxes();
                }, 2000);
                setTimeout(() => window.location.href = "/report.html?i=1", 1000);

            } catch (err) {
                alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö: " + err.message + "\n(‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google Sheet API ‡∏Ñ‡∏£‡∏±‡∏ö)");
                console.error("Error during submission:", err);
                document.getElementById("loadingMessage").style.display = "none";
            }
        }

        async function checkDuplicateMachines() {
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const year = today.getFullYear();
            const todayDateFormatted = `${year}-${month}-${day}`;

            const selectedShift = document.querySelector('input[name="shift"]:checked')?.value;

            // Show fieldsets when a shift is selected
            if (selectedShift) {
                document.getElementById('machine-fieldset').style.display = 'block';
                document.getElementById('data-fieldset').style.display = 'block';
            } else {
                document.getElementById('machine-fieldset').style.display = 'none';
                document.getElementById('data-fieldset').style.display = 'none';
            }


            // 1. Reset all machine checkboxes and hide their input rows initially
            document.querySelectorAll('.machine-grid input[type="checkbox"]').forEach(cb => {
                const machineId = cb.id.replace('cb-', '');
                const row = document.getElementById(`inputs-${machineId}`);
                cb.disabled = false;
                cb.checked = false;
                if (row) row.style.display = 'none';

                document.getElementById(`rejects-${machineId}`).value = '';
                document.getElementById(`cycleshift-${machineId}`).value = '';
                document.getElementById(`cycletime-${machineId}`).value = '';
                document.getElementById(`mold-status-${machineId}`).checked = false;
                document.getElementById(`mesh-status-${machineId}`).checked = false;
                document.getElementById(`fmrob-status-${machineId}`).checked = false;
                document.getElementById(`rejects-${machineId}`).disabled = false;
                document.getElementById(`cycleshift-${machineId}`).disabled = false;
                document.getElementById(`cycletime-${machineId}`).disabled = false;
                document.getElementById(`mold-status-${machineId}`).disabled = false;
                document.getElementById(`mesh-status-${machineId}`).disabled = false;
                document.getElementById(`fmrob-status-${machineId}`).disabled = false;
            });

            duplicateMachineIds.clear();

            // Clear any error messages and borders when shift changes
            document.getElementById('shift-fieldset').classList.remove('error-border');
            document.getElementById('shift-alert-message').textContent = '';
            document.getElementById('machine-fieldset').classList.remove('error-border');
            document.getElementById('machine-alert-message').textContent = '';
            document.getElementById('data-fieldset').classList.remove('error-border');
            document.getElementById('data-alert-message').textContent = '';

            let alertMachineIds = [];
            const machineDataMap = new Map();

            if (!selectedShift) {
                return;
            }

            try {
                // Fetch data only once per day/shift combination if not already cached
                // *** IMPORTANT: Update the range 'A2:J' to 'A2:L' (or whatever column FM&Rob is in)
                // *** in your Google Apps Script if you want to fetch this data.
                if (todayDateFormatted !== lastFetchDate || selectedShift !== lastFetchShift || allSheetDataCache.length === 0) {
                    const res = await fetch(
                        `https://sheets.googleapis.com/v4/spreadsheets/1Nmcrwydbke_qMdMqYEH2Mk85MQzy3bsRQVSfLKP5Edw/values/Cycle_Time!A2:L?key=AIzaSyB_Jrjw4_H6qm4QTUUSCcz5z2A7xGL_dAQ`
                    );
                    if (!res.ok) {
                        throw new Error(`HTTP error! status: ${res.status}`);
                    }
                    const json = await res.json();
                    allSheetDataCache = json.values || [];
                    lastFetchDate = todayDateFormatted;
                    lastFetchShift = selectedShift;
                }

                allSheetDataCache.forEach(row => {
                    const date = row[0];
                    const machine = row[2];
                    const rejects = row[3];
                    const cycleShift = row[4];
                    const cycleTime = row[5];
                    const moldStatus = row[6]; // Assuming Mold Status is in column G (index 6)
                    const shift = row[8]; // Assuming Shift is in column I (index 8)
                    const meshStatus = row[9]; // Assuming Mesh Status is in column J (index 9)
                    const fmrobStatus = row[11]; // Assuming FM&Rob Status is in column L (index 11)

                    if (date === todayDateFormatted && shift === selectedShift && machine) {
                        machineDataMap.set(`${machine}-${shift}`, {
                            rejects: rejects,
                            cycleShift: cycleShift,
                            cycleTime: cycleTime,
                            moldStatus: moldStatus,
                            meshStatus: meshStatus,
                            fmrobStatus: fmrobStatus
                        });
                    }
                });

                document.querySelectorAll('.machine-grid input[type="checkbox"]').forEach(cb => {
                    const machineId = cb.id.replace('cb-', '');
                    const pairKey = `${machineId}-${selectedShift}`;

                    if (machineDataMap.has(pairKey)) {
                        const data = machineDataMap.get(pairKey);
                        if (!cb.disabled) {
                            alertMachineIds.push(machineId);
                        }
                        cb.disabled = true;
                        cb.checked = true;
                        toggleInputs(machineId, data);
                        duplicateMachineIds.add(machineId);
                    } else {
                        cb.disabled = false;
                        toggleInputs(machineId);
                        duplicateMachineIds.delete(machineId);
                    }
                });

                if (alertMachineIds.length > 0) {
                    alertMachineIds.sort(machineSort);
                    const formattedMachineIds = alertMachineIds.join(', ');
                    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å alert() ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô machineAlertMessage
                    const machineFieldset = document.getElementById('machine-fieldset');
                    const machineAlertMessage = document.getElementById('machine-alert-message');
                    machineAlertMessage.innerHTML = `‚ö†Ô∏è <span style="color: blue;">${formattedMachineIds}</span> ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß`;
                    machineFieldset.classList.add('error-border');
                }

            } catch (error) {
                console.error("Error checking duplicate data:", error);
                // ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÉ‡∏ä‡πâ alert ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠/API ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö
                alert("‡∏≠‡πä‡∏∞! ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥‡∏Ñ‡∏£‡∏±‡∏ö: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö");
            }
        }

        function selectShiftBasedOnTime() {
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();

            let selectedShiftValue = '';

            // ‡∏Å‡∏∞‡∏î‡∏∂‡∏Å: 23:59 - 8:00
            if (currentHour >= 0 && currentHour < 8) { // 00:00 - 07:59
                selectedShiftValue = '‡∏Å‡∏∞‡∏î‡∏∂‡∏Å';
            } else if (currentHour === 23 && currentMinute >= 59) { // 23:59 onwards
                selectedShiftValue = '‡∏Å‡∏∞‡∏î‡∏∂‡∏Å';
            } else if (currentHour >= 8 && currentHour < 16) { // ‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤: 8:00 - 15:59
                selectedShiftValue = '‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤';
            } else if (currentHour >= 16 && currentHour < 24) { // ‡∏Å‡∏∞‡∏ö‡πà‡∏≤‡∏¢: 16:00 - 23:59
                selectedShiftValue = '‡∏Å‡∏∞‡∏ö‡πà‡∏≤‡∏¢';
            }

            if (selectedShiftValue) {
                const radios = document.querySelectorAll('input[name="shift"]');
                radios.forEach(radio => {
                    if (radio.value === selectedShiftValue) {
                        radio.checked = true;
                        // Manually trigger the change event for the selected radio to update UI
                        const event = new Event('change');
                        radio.dispatchEvent(event);
                    }
                });
            }
        }


        document.addEventListener("DOMContentLoaded", async () => {
            const grid = document.querySelector(".machine-grid");
            const tbody = document.querySelector("table tbody");

            function getFormattedDate(date) {
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            }

            const today = new Date();
            document.getElementById('cycleTimeTitle').innerHTML = `
            ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Cycle Time ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${getFormattedDate(today)}
            `;

            for (let i = 1; i <= 8; i++) {
                ['A', 'B', 'C'].forEach(group => {
                    const id = group + i;
                    const label = document.createElement("label");
                    label.innerHTML = `<input type="checkbox" id="cb-${id}" onchange="toggleInputs('${id}'); checkMachineSelectionAndHideAlert();"> ${id}`;
                    grid.appendChild(label);
                });
            }

            ['A','B','C'].forEach(group => {
                for (let i = 1; i <= 8; i++) {
                    const id = group + i;
                    const tr = document.createElement("tr");
                    tr.id = `inputs-${id}`;
                    tr.style.display = "none";
                    tr.innerHTML = `
                        <td class="col-macno">${id}</td>
                        <td class="col-rejs"><input type="number" id="rejects-${id}" value="" min="0" class="small-input" oninput="checkDataInputCompletionAndHideAlert()"></td>
                        <td class="col-cycshf"><input type="number" id="cycleshift-${id}" value="" min="0" class="medium-input" oninput="checkDataInputCompletionAndHideAlert()"></td>
                        <td class="col-cyctime"><input type="number" id="cycletime-${id}" value="" min="0" class="medium-input" oninput="checkDataInputCompletionAndHideAlert()"></td>
                        <td class="col-status-short"><div class="form-check"><input type="checkbox" id="mold-status-${id}" onchange="toggleMoldStatusCheckbox('${id}')"></div></td>
                        <td class="col-status-short"><div class="form-check"><input type="checkbox" id="mesh-status-${id}" onchange="checkDataInputCompletionAndHideAlert()"></div></td>
                        <td class="col-fmrob"><div class="form-check"><input type="checkbox" id="fmrob-status-${id}" onchange="checkDataInputCompletionAndHideAlert()"></div></td>
                    `;
                    tbody.appendChild(tr);
                }
            });

            // Select shift based on current time
            selectShiftBasedOnTime();

            document.querySelectorAll('input[name="shift"]').forEach(radio => {
                radio.addEventListener('change', checkDuplicateMachines);
            });
            // Ensure checkDuplicateMachines is called initially in case the auto-selected shift has data
            checkDuplicateMachines();
        });
    </script>
</head>

<body>
    <button onclick="window.location.href='/report.html?i=1'">üìä ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</button>
    <button onclick="window.location.href='/summary.html?i=1'">üìÑ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    <button onclick="window.location.href='/running.html?i=1'">‚è≥ Running Time</button>
    <button onclick="window.location.href='/edit.html?i=1'">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    <h2 id="cycleTimeTitle"></h2>
    <fieldset id="shift-fieldset">
        <legend>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏∞</legend>
        <div class="shift-row">
            <label>
                <input type="radio" name="shift" value="‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤"> ‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤</label>
            <label>
                <input type="radio" name="shift" value="‡∏Å‡∏∞‡∏ö‡πà‡∏≤‡∏¢"> ‡∏Å‡∏∞‡∏ö‡πà‡∏≤‡∏¢</label>
            <label>
                <input type="radio" name="shift" value="‡∏Å‡∏∞‡∏î‡∏∂‡∏Å"> ‡∏Å‡∏∞‡∏î‡∏∂‡∏Å</label>
        </div>
        <div id="shift-alert-message" class="alert-message"></div>
    </fieldset>
    <fieldset id="machine-fieldset">
        <legend>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ Line A B C</legend>
        <div id="machine-alert-message" class="alert-message"></div><br>
        <div class="machine-grid"></div>
        <div class="button-row">
            <button type="button" onclick="clearCheckboxes()">üß∫ ‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            <button onclick="submitData()">üì§ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
    </fieldset>
    <fieldset id="data-fieldset">
        <legend>‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</legend>
        <div id="data-alert-message" class="alert-message"></div>
        <table>
          <div id="loadingMessage">
        ‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• <span class="loading-dot">.</span><span class="loading-dot">.</span><span class="loading-dot">.</span>
          </div><br>
            <thead>
                <tr>
                    <th class="col-macno">MacNo.</th>
                    <th class="col-rejs">Rejs</th>
                    <th class="col-cycshf">Cyc Shf</th>
                    <th class="col-cyctime">Cyc Time</th>
                    <th class="col-status-short">‡∏¢‡∏Å‡∏•‡πâ‡∏≤‡∏á</th>
                    <th class="col-status-short">‡∏Ç‡∏±‡∏îMold</th>
                    <th class="col-fmrob">FM&Rob</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </fieldset>
</body>
</html>
